"""
Configuration d'authentification pour l'application Streamlit.
"""

import streamlit_authenticator as stauth
import yaml
from yaml.loader import SafeLoader
import os
from pathlib import Path

# Chemin vers le fichier de configuration
auth_file = Path(__file__).parent / 'auth_config.yaml'

# Configuration par défaut
DEFAULT_CONFIG = {
    'credentials': {
        'usernames': {
            'admin': {
                'email': 'admin@example.com',
                'name': 'Administrateur',
                'password': '',  # Sera rempli lors de l'initialisation
                'role': 'admin'
            },
            'user': {
                'email': 'user@example.com',
                'name': 'Utilisateur Standard',
                'password': '',  # Sera rempli lors de l'initialisation
                'role': 'user'
            }
        }
    },
    'cookie': {
        'expiry_days': 30,
        'key': 'streamlit_auth_key',
        'name': 'streamlit_auth_cookie'
    },
    'preauthorized': {
        'emails': []
    }
}

def init_auth_config():
    """Initialise le fichier de configuration d'authentification s'il n'existe pas."""
    if not auth_file.exists():
        # Créer une copie de la configuration par défaut
        config = DEFAULT_CONFIG.copy()
        
        # Définir les mots de passe en texte clair
        config['credentials']['usernames']['admin']['password'] = 'admin123'
        config['credentials']['usernames']['user']['password'] = 'user123'
        
        # Hacher les mots de passe avec la nouvelle méthode
        config['credentials'] = stauth.Hasher.hash_passwords(config['credentials'])
        
        # Créer le dossier parent si nécessaire
        auth_file.parent.mkdir(parents=True, exist_ok=True)
        
        # Sauvegarder la configuration
        with open(auth_file, 'w') as f:
            yaml.dump(config, f, default_flow_style=False)

def load_auth_config():
    """Charge la configuration d'authentification."""
    # S'assurer que le fichier existe
    if not auth_file.exists():
        init_auth_config()
    
    # Charger la configuration
    with open(auth_file) as f:
        return yaml.load(f, Loader=SafeLoader)

def get_authenticator():
    """Retourne un objet d'authentification Streamlit configuré."""
    config = load_auth_config()
    return stauth.Authenticate(
        config['credentials'],
        config['cookie']['name'],
        config['cookie']['key'],
        config['cookie']['expiry_days']
    )

def get_user_role(username):
    """Récupère le rôle d'un utilisateur."""
    config = load_auth_config()
    return config['credentials']['usernames'].get(username, {}).get('role', 'user')
